<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bingo Fiesta V7</title>
    
    <!-- LIBRERÍAS -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* Prevenir zoom y comportamientos extraños en móvil */
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; background-color: #0f172a; color: white; overflow: hidden; }
        .win-pulse { animation: winPulse 2s infinite; }
        @keyframes winPulse { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }
        /* Scroll elegante */
        .scroller { overflow-y: auto; scrollbar-width: thin; scrollbar-color: #475569 #1e293b; }
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: #1e293b; }
        .scroller::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        window.onerror = function(message) {
            document.body.innerHTML = '<div style="padding:20px;text-align:center;color:red;"><h2>Error</h2><p>'+message+'</p><button onclick="localStorage.clear();location.reload()" style="background:white;color:black;padding:10px;">REINICIAR</button></div>';
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONOS ---
        const Icon = ({ name }) => {
            const icons = {
                arrowLeft: <path d="M19 12H5M12 19l-7-7 7-7" />,
                volume: <path d="M11 5L6 9H2v6h4l5 4V5zM15.54 8.46a5 5 0 0 1 0 7.07" />,
                play: <polygon points="5 3 19 12 5 21 5 3" />,
                pause: <path d="M6 4h4v16H6zm8 0h4v16h-4z" />,
                refresh: <path d="M23 4v6h-6M1 20v-6h6" />,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
                check: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />,
                ticket: <path d="M3 7v2a3 3 0 0 1 3 3 3 3 0 0 1-3 3v2a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-2a3 3 0 0 1-3-3 3 3 0 0 1 3-3V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2z" />,
                tv: <><rect x="2" y="7" width="20" height="15" rx="2" ry="2" /><polyline points="17 2 12 7 7 2" /></>,
                finger: <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />,
                layers: <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{icons[name] || <circle cx="12" cy="12" r="10"/>}</svg>;
        };

        // --- GENERADOR CARTONES ---
        const generateCard = () => {
            const ranges = [[1,9], [10,19], [20,29], [30,39], [40,49], [50,59], [60,69], [70,79], [80,90]];
            let grid, attempts = 0;
            while(attempts < 2000) {
                grid = Array(3).fill(null).map(() => Array(9).fill(null));
                const rc = [0,0,0], cc = Array(9).fill(0);
                for(let c=0; c<9; c++) { let r; do{r=Math.floor(Math.random()*3)}while(rc[r]>=5); grid[r][c]="P"; rc[r]++; cc[c]++; }
                let rem=6; while(rem>0) { let c=Math.floor(Math.random()*9); if(cc[c]<2) { const vr=[0,1,2].filter(r=>grid[r][c]===null&&rc[r]<5); if(vr.length){ const r=vr[Math.floor(Math.random()*vr.length)]; grid[r][c]="P"; rc[r]++; cc[c]++; rem--; } } }
                for(let c=0; c<9; c++) { const s=[]; for(let r=0; r<3; r++) if(grid[r][c]==="P") s.push(r); const n=new Set(); const [min,max]=ranges[c]; while(n.size<s.length) n.add(Math.floor(Math.random()*(max-min+1))+min); const sorted=Array.from(n).sort((a,b)=>a-b); s.forEach((r,i)=>grid[r][c]=sorted[i]); }
                if(rc.every(c=>c===5)) return grid; attempts++;
            }
            return grid;
        };

        // --- MODO JUGADOR ---
        const Player = ({ onBack }) => {
            const [grid, setGrid] = useState(() => { try { return JSON.parse(localStorage.getItem('b_g')) || generateCard(); } catch { return generateCard(); } });
            const [marks, setMarks] = useState(() => { try { return new Set(JSON.parse(localStorage.getItem('b_m'))); } catch { return new Set(); } });
            const [target, setTarget] = useState('line'); 
            const [alert, setAlert] = useState(null);

            useEffect(() => { localStorage.setItem('b_g', JSON.stringify(grid)); }, [grid]);
            useEffect(() => { localStorage.setItem('b_m', JSON.stringify(Array.from(marks))); check(); }, [marks, target]);

            const check = () => {
                let rows = 0; grid.forEach(row => { if(row.filter(n=>n).every(n=>marks.has(n))) rows++; });
                const total = Array.from(marks).filter(m => grid.some(r => r.includes(m))).length;
                if (total === 15 && alert !== 'BINGO') { setAlert('BINGO'); confetti({particleCount:300,spread:70}); }
                else if (target === 'line' && rows > 0 && total < 15 && alert !== 'LINEA') { setAlert('LINEA'); confetti({particleCount:100,spread:70}); }
            };

            const toggle = (n) => { if(!n) return; const nm = new Set(marks); if(nm.has(n)) nm.delete(n); else nm.add(n); setMarks(nm); };

            return (
                <div className="flex flex-col h-screen bg-slate-900 scroller">
                    <div className="sticky top-0 z-50 bg-slate-800 shadow-xl p-3 flex justify-between items-center">
                        <button onClick={onBack} className="p-2 bg-slate-700 rounded-full"><Icon name="arrowLeft"/></button>
                        <div className="text-center"><p className="text-xs text-slate-400 font-bold">OBJETIVO</p><p className={`text-xl font-black ${target==='line'?'text-green-400':'text-pink-500'}`}>{target==='line'?"LÍNEA":"BINGO"}</p></div>
                        <div className="w-10"></div>
                    </div>
                    {alert && <div className={`w-full py-2 text-center font-black animate-pulse ${alert==='BINGO'?'bg-yellow-500 text-black':'bg-green-600 text-white'}`}>¡¡ {alert} !!</div>}
                    <div className="p-4 flex-1 flex flex-col items-center justify-center">
                        <div className={`w-full max-w-3xl bg-[#fff9e6] border-4 border-amber-800 rounded-lg p-2 shadow-2xl relative select-none transition-transform ${alert==='BINGO'?'scale-105 shadow-yellow-500/50':''}`}>
                            <div className="flex justify-between items-end border-b-2 border-amber-900/20 pb-2 mb-2"><h1 className="text-3xl sm:text-4xl font-black text-amber-900">BINGO</h1><span className="text-xs font-bold text-amber-900/50">TOCA PARA TACHAR</span></div>
                            <div className="grid grid-rows-3 gap-0 border-2 border-amber-900 bg-amber-50">
                                {grid.map((row, i) => (
                                    <div key={i} className={`grid grid-cols-9 divide-x-2 divide-amber-900 h-16 sm:h-24 md:h-28 ${i<2?'border-b-2 border-amber-900':''} ${row.filter(n=>n).every(n=>marks.has(n))?'bg-green-200':''}`}>
                                        {row.map((n, j) => (
                                            <div key={j} onClick={()=>toggle(n)} className="relative flex items-center justify-center cursor-pointer active:bg-amber-200">
                                                {n && <><span className={`text-xl sm:text-4xl md:text-5xl font-bold z-10 ${marks.has(n)?'text-amber-900/30':'text-slate-900'}`}>{n}</span>{marks.has(n)&&<div className="absolute w-8 h-8 sm:w-14 sm:h-14 md:w-16 md:h-16 rounded-full bg-red-600/70 border-2 border-red-800 pointer-events-none"></div>}</>}
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </div>
                        {target==='line' && <button onClick={()=>{if(confirm("¿Cambiar a Bingo?"))setTarget('bingo')}} className="mt-8 w-full max-w-sm py-4 bg-slate-800 border border-pink-500 rounded-xl flex justify-center gap-2 text-pink-400 font-bold">Ya hay Línea → Ir a Bingo</button>}
                        <div className="mt-8 flex gap-4 w-full max-w-sm mb-8"><button onClick={()=>{if(confirm("¿Borrar?"))setMarks(new Set())}} className="flex-1 py-3 bg-slate-800 rounded-xl font-bold text-slate-400 flex justify-center gap-2"><Icon name="trash"/> Limpiar</button><button onClick={()=>{if(confirm("¿Nuevo?"))setGrid(generateCard())}} className="flex-1 py-3 bg-slate-800 rounded-xl font-bold text-slate-400 flex justify-center gap-2"><Icon name="refresh"/> Nuevo</button></div>
                    </div>
                </div>
            );
        };

        // --- MODO FÁBRICA ---
        const Factory = ({ onBack }) => {
            const [grid, setGrid] = useState(generateCard());
            const [c, setC] = useState(1);
            const ref = useRef();
            const download = async () => {
                const cvs = await html2canvas(ref.current, {scale:2, backgroundColor:null});
                const l = document.createElement('a'); l.download=`Carton_${c}.png`; l.href=cvs.toDataURL(); l.click();
                setTimeout(()=>{setGrid(generateCard()); setC(c+1)}, 200);
            };
            return (
                <div className="flex flex-col items-center min-h-screen bg-slate-900 p-4 border-t-8 border-green-500 scroller">
                    <button onClick={onBack} className="self-start mb-4 p-2 bg-slate-800 rounded-full"><Icon name="arrowLeft"/></button>
                    <h2 className="text-2xl font-bold text-green-400 mb-4">Fábrica #{c}</h2>
                    <div className="bg-white p-1 rounded overflow-hidden origin-top scale-75">
                         <div ref={ref} className="bg-[#fff9e6] border-4 border-amber-800 p-4 w-[800px] text-slate-900 font-mono">
                            <h2 className="text-4xl font-black text-amber-900 mb-2">BINGO #{c}</h2>
                            <div className="border-2 border-amber-900 grid grid-rows-3 bg-amber-100/50">
                                {grid.map((r,i)=><div key={i} className={`grid grid-cols-9 divide-x-2 divide-amber-900 ${i<2?'border-b-2 border-amber-900':''}`}>{r.map((n,j)=><div key={j} className="h-24 flex items-center justify-center font-bold text-6xl">{n}</div>)}</div>)}
                            </div>
                        </div>
                    </div>
                    <button onClick={download} className="fixed bottom-10 px-8 py-4 bg-green-600 rounded-xl font-bold shadow-xl flex gap-2">DESCARGAR Y SIGUIENTE</button>
                </div>
            );
        };

        // --- MODO BOMBO (CALLER) ---
        const Caller = ({ onBack }) => {
            const [history, setHistory] = useState([]);
            const [current, setCurrent] = useState(null);
            const [auto, setAuto] = useState(false);
            const [audioOn, setAudioOn] = useState(false);
            const [checking, setChecking] = useState(false);
            const timerRef = useRef(null);

            const playSound = (text) => {
                if(!window.speechSynthesis) return;
                try { const Ctx = window.AudioContext || window.webkitAudioContext; if(Ctx){const ctx=new Ctx();const o=ctx.createOscillator();o.connect(ctx.destination);o.start();o.stop(ctx.currentTime+0.01);} } catch(e){}
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text); u.lang = 'es-ES'; u.rate = 1;
                window.speechSynthesis.speak(u);
            };

            const draw = () => {
                if(history.length >= 90) return setAuto(false);
                let n; do { n = Math.floor(Math.random()*90)+1; } while(history.includes(n));
                setHistory(p => [n, ...p]); setCurrent(n); playSound(`${n}`);
            };

            useEffect(() => { if(auto && !checking) timerRef.current = setInterval(draw, 4000); else clearInterval(timerRef.current); return () => clearInterval(timerRef.current); }, [auto, checking, history]);

            if(!audioOn) return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 p-6 text-center">
                    <div className="mb-6 text-pink-500 animate-bounce"><Icon name="volume"/></div>
                    <h1 className="text-3xl font-black mb-4">MODO TV / BOMBO</h1>
                    <button onClick={()=>{setAudioOn(true); playSound("Conectado")}} className="w-full max-w-md py-5 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl font-bold text-xl shadow-lg">CONECTAR SONIDO</button>
                    <button onClick={onBack} className="mt-6 text-slate-500 underline">Volver</button>
                </div>
            );

            if(checking) return (
                <div className="flex flex-col h-screen bg-slate-900 p-4">
                    <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-pink-500">COMPROBADOR</h2><button onClick={()=>{setChecking(false); playSound("Seguimos")}} className="bg-slate-800 px-4 py-2 rounded font-bold">VOLVER</button></div>
                    <div className="flex-1 overflow-y-auto bg-slate-800 rounded-xl p-2 scroller"><div className="grid grid-cols-10 gap-2">{Array.from({length:90},(_,i)=>i+1).map(n => (<button key={n} onClick={()=> playSound(history.includes(n) ? "Correcto" : "No ha salido")} className={`aspect-square font-bold rounded ${history.includes(n)?'bg-green-600 text-white':'bg-slate-900 text-slate-600'}`}>{n}</button>))}</div></div>
                    <div className="grid grid-cols-2 gap-4 mt-4 h-20"><button onClick={()=>{setChecking(false); playSound("Línea correcta")}} className="bg-blue-600 rounded-xl font-black">¡LÍNEA!</button><button onClick={()=>{setChecking(false); playSound("Bingo correcto")}} className="bg-pink-600 rounded-xl font-black">¡BINGO!</button></div>
                </div>
            );

            return (
                <div className="flex flex-col md:flex-row h-screen bg-slate-900 overflow-hidden">
                    {/* ZONA BOLA (Izquierda) */}
                    <div className="flex-1 flex flex-col items-center justify-center p-2 relative border-b md:border-b-0 md:border-r border-slate-700 h-[40vh] md:h-auto">
                        <div className="absolute top-2 left-2 md:hidden"><button onClick={()=>{setAuto(false);onBack()}} className="p-2 bg-slate-800 rounded-full"><Icon name="arrowLeft"/></button></div>
                        <div className="absolute top-2 right-2 md:hidden bg-slate-800 px-3 py-1 rounded-full text-blue-300 font-bold">{history.length}/90</div>

                        <div onClick={()=>current && playSound(`${current}`)} className="h-[70%] aspect-square bg-slate-800 rounded-full border-8 border-slate-700 flex items-center justify-center shadow-2xl cursor-pointer active:scale-95 transition-transform">
                            <span className="text-[7rem] sm:text-[9rem] md:text-[15rem] font-black leading-none">{current || "--"}</span>
                        </div>
                        <div className="mt-2 text-slate-500 text-sm md:text-xl font-bold">ÚLTIMO NÚMERO</div>
                    </div>

                    {/* ZONA PANEL (Derecha) */}
                    <div className="flex-[1.5] flex flex-col bg-slate-950 p-2 md:p-4 h-[60vh] md:h-auto">
                        <div className="hidden md:flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">PANEL DE CONTROL</h2>
                            <div className="flex gap-4">
                                <button onClick={()=>{setAuto(false);onBack()}} className="px-4 py-2 bg-slate-800 rounded-lg hover:bg-slate-700 font-bold">SALIR</button>
                                <button onClick={()=>{if(confirm("Reiniciar?")){setHistory([]);setCurrent(null);setAuto(false)}}} className="px-4 py-2 bg-red-900/50 text-red-400 rounded-lg hover:bg-red-900 font-bold">REINICIAR</button>
                            </div>
                        </div>

                        {/* GRID SCROLLABLE */}
                        <div className="flex-1 bg-slate-900 rounded-2xl p-2 border border-slate-800 shadow-inner scroller relative overflow-y-auto">
                            <div className="grid grid-cols-10 gap-1 content-start">
                                {Array.from({length:90},(_,i)=>i+1).map(n => (
                                    <div key={n} className={`aspect-square md:aspect-auto md:h-12 flex items-center justify-center rounded font-bold text-sm md:text-lg transition-all duration-300 ${history.includes(n)?'bg-green-500 text-white shadow-[0_0_10px_rgba(34,197,94,0.5)]':'bg-slate-800 text-slate-600'}`}>
                                        {n}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* CONTROLES FIXED BOTTOM */}
                        <div className="mt-2 flex gap-2 h-16 md:h-20 shrink-0">
                            <div className="flex-1 bg-slate-900 rounded-2xl flex items-center justify-center gap-2 md:gap-6 border border-slate-800">
                                <button onClick={()=>setAuto(!auto)} className={`flex-1 md:flex-none px-4 md:px-6 py-2 md:py-3 rounded-xl font-black text-sm md:text-xl flex items-center justify-center gap-2 transition-all ${auto?'bg-amber-500 text-black shadow-[0_0_20px_rgba(245,158,11,0.4)]':'bg-slate-700 hover:bg-slate-600'}`}>
                                    {auto ? <><Icon name="pause"/> PAUSA</> : <><Icon name="play"/> AUTO</>}
                                </button>
                                <button onClick={draw} disabled={auto} className="flex-[2] md:flex-none px-4 md:px-6 py-2 md:py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-lg md:text-xl shadow-lg active:translate-y-1">
                                    SACAR
                                </button>
                            </div>
                            <button onClick={()=>{setAuto(false);setChecking(true)}} className="w-16 md:w-40 bg-pink-600 hover:bg-pink-500 rounded-2xl font-black text-xs md:text-lg flex flex-col items-center justify-center shadow-lg">
                                <span className="md:hidden"><Icon name="ticket"/></span>
                                <span className="hidden md:inline"><Icon name="ticket"/> COMPROBAR</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MENÚ ---
        const Menu = ({ setMode }) => (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-b from-blue-900 to-slate-900 p-4 text-center scroller">
                <h1 className="text-7xl sm:text-9xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-indigo-500 mb-8 drop-shadow-2xl">BINGO</h1>
                <div className="flex flex-col sm:flex-row gap-6 w-full max-w-4xl justify-center">
                    <button onClick={()=>setMode('player')} className="flex-1 p-8 bg-slate-800 rounded-3xl border-2 border-slate-700 hover:border-pink-500 transition-all hover:-translate-y-2 shadow-2xl group">
                        <div className="bg-pink-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform"><Icon name="finger"/></div>
                        <h2 className="text-2xl font-black mb-2">SOY JUGADOR</h2>
                        <p className="text-slate-400">Cartón en el móvil</p>
                    </button>
                    <button onClick={()=>setMode('caller')} className="flex-1 p-8 bg-slate-800 rounded-3xl border-2 border-slate-700 hover:border-blue-500 transition-all hover:-translate-y-2 shadow-2xl group">
                        <div className="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform"><Icon name="tv"/></div>
                        <h2 className="text-2xl font-black mb-2">MODO TV</h2>
                        <p className="text-slate-400">Bombo y Pantalla</p>
                    </button>
                </div>
                <div className="hidden sm:block mt-12 text-slate-500 text-sm">Bingo Fiesta V7.0</div>
                <button onClick={()=>{setMode('factory')}} className="mt-8 text-xs text-slate-600 hover:text-white flex items-center justify-center gap-2"><Icon name="layers"/> Imprimir Cartones</button>
            </div>
        );

        const App = () => {
            const [mode, setMode] = useState('menu');
            return mode === 'menu' ? <Menu setMode={setMode}/> :
                   mode === 'player' ? <Player onBack={()=>setMode('menu')}/> :
                   mode === 'factory' ? <Factory onBack={()=>setMode('menu')}/> :
                   <Caller onBack={()=>setMode('menu')}/>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>



