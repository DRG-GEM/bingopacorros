<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bingo Fiesta</title>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para traducir el código en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Librería para capturas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { touch-action: manipulation; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-900 text-white select-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Iconos SVG simples para no depender de librerías externas pesadas
        const Icon = ({ name, size=24 }) => {
            const icons = {
                share: <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8m-4-6-4-4-4 4m4-4v13" />,
                volume: <path d="M11 5L6 9H2v6h4l5 4V5zM15.54 8.46a5 5 0 0 1 0 7.07" />,
                layers: <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />,
                play: <polygon points="5 3 19 12 5 21 5 3" />,
                pause: <path d="M6 4h4v16H6zm8 0h4v16h-4z" />,
                refresh: <path d="M23 4v6h-6M1 20v-6h6" />, 
                arrowLeft: <path d="M19 12H5M12 19l-7-7 7-7" />,
                ticket: <path d="M3 7v2a3 3 0 0 1 3 3 3 3 0 0 1-3 3v2a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-2a3 3 0 0 1-3-3 3 3 0 0 1 3-3V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2z" />,
                check: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />
            };
            
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round"
                >
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        // --- GENERADOR DE CARTONES ---
        const generate90BallCard = () => {
            const colRanges = [
                { min: 1, max: 9 }, { min: 10, max: 19 }, { min: 20, max: 29 },
                { min: 30, max: 39 }, { min: 40, max: 49 }, { min: 50, max: 59 },
                { min: 60, max: 69 }, { min: 70, max: 79 }, { min: 80, max: 90 }
            ];
            let grid, rowCounts, attempts = 0;
            while (attempts < 2000) {
                grid = Array(3).fill(null).map(() => Array(9).fill(null));
                rowCounts = [0, 0, 0];
                const colCounts = Array(9).fill(0);
                let valid = true;
                for (let c = 0; c < 9; c++) {
                    let r = Math.floor(Math.random() * 3);
                    while(rowCounts[r] >= 5) r = (r + 1) % 3;
                    grid[r][c] = "P"; rowCounts[r]++; colCounts[c]++;
                }
                let remaining = 6;
                while (remaining > 0) {
                    let c = Math.floor(Math.random() * 9);
                    if (colCounts[c] >= 2) continue;
                    let potentialRows = [0, 1, 2].filter(r => grid[r][c] === null && rowCounts[r] < 5);
                    if (potentialRows.length === 0) continue;
                    let r = potentialRows[Math.floor(Math.random() * potentialRows.length)];
                    grid[r][c] = "P"; rowCounts[r]++; colCounts[c]++; remaining--;
                }
                for (let c = 0; c < 9; c++) {
                    const slots = [];
                    for(let r=0; r<3; r++) if(grid[r][c]==="P") slots.push(r);
                    const nums = new Set();
                    while(nums.size < slots.length) nums.add(Math.floor(Math.random() * (colRanges[c].max - colRanges[c].min + 1)) + colRanges[c].min);
                    const sorted = Array.from(nums).sort((a,b)=>a-b);
                    slots.forEach((r, i) => grid[r][c] = sorted[i]);
                }
                if (valid) break;
                attempts++;
            }
            return grid;
        };

        // --- COMPONENTE VISUAL DEL CARTÓN ---
        const BingoCardVisual = ({ grid, serial, cardRef }) => (
            <div ref={cardRef} className="bg-[#fff9e6] border-4 border-amber-800 p-2 sm:p-4 rounded-lg w-[800px] max-w-full text-slate-900 font-mono relative mx-auto select-none">
                <div className="flex justify-between items-end border-b-2 border-amber-900/30 pb-2 mb-2">
                    <h2 className="text-2xl sm:text-3xl font-black text-amber-900">BINGO 90</h2>
                    <div className="text-[10px] font-bold text-amber-900/60 flex flex-col items-end"><span>ID: {serial || "001"}</span></div>
                </div>
                <div className="border-2 border-amber-900 grid grid-rows-3 bg-amber-100/50">
                    {grid.map((row, i) => (
                        <div key={i} className={`grid grid-cols-9 divide-x-2 divide-amber-900 ${i<2 ? 'border-b-2 border-amber-900' : ''}`}>
                            {row.map((n, j) => (
                                <div key={j} className="h-10 sm:h-16 flex items-center justify-center relative">
                                    {n ? <span className="text-xl sm:text-4xl font-bold text-slate-900 z-10">{n}</span> : null}
                                </div>
                            ))}
                        </div>
                    ))}
                </div>
            </div>
        );

        // --- MODOS ---
        const MainMenu = ({ onSelectMode }) => (
            <div className="flex flex-col items-center justify-center min-h-screen p-4 text-center bg-gradient-to-b from-blue-900 to-slate-900">
                <h1 className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-indigo-500 mb-8">BINGO</h1>
                <div className="grid gap-4 w-full max-w-sm">
                    <button onClick={() => onSelectMode('player')} className="p-4 bg-slate-800 rounded-2xl border border-slate-700 flex items-center gap-4 text-lg font-bold hover:bg-slate-700"><Icon name="share"/> Soy Jugador</button>
                    <button onClick={() => onSelectMode('factory')} className="p-4 bg-slate-800 rounded-2xl border border-slate-700 flex items-center gap-4 text-lg font-bold hover:bg-slate-700"><Icon name="layers"/> Fábrica Cartones</button>
                    <button onClick={() => onSelectMode('caller')} className="p-4 bg-slate-800 rounded-2xl border border-blue-500 shadow-lg flex items-center gap-4 text-lg font-bold hover:bg-slate-700"><Icon name="volume"/> BOMBO (JUGAR)</button>
                </div>
            </div>
        );

        const PlayerMode = ({ onBack }) => {
            const [grid, setGrid] = useState(generate90BallCard());
            const cardRef = useRef(null);
            const handleDownload = async () => {
                const c = await html2canvas(cardRef.current, {scale:2, backgroundColor:null});
                const l = document.createElement('a'); l.download=`Carton-${Date.now()}.png`; l.href=c.toDataURL(); l.click();
            };
            return (
                <div className="flex flex-col items-center min-h-screen p-4 bg-slate-900">
                    <button onClick={onBack} className="self-start mb-4 p-2 bg-slate-800 rounded-full"><Icon name="arrowLeft"/></button>
                    <div className="bg-white p-1 rounded-xl shadow-lg mb-4 max-w-full overflow-hidden scale-95"><BingoCardVisual grid={grid} cardRef={cardRef}/></div>
                    <button onClick={handleDownload} className="w-full max-w-sm py-3 bg-green-600 rounded-xl font-bold mb-2 flex items-center justify-center gap-2"><Icon name="download"/> Descargar</button>
                    <button onClick={()=>setGrid(generate90BallCard())} className="w-full max-w-sm py-3 bg-slate-800 rounded-xl font-bold">Nuevo Cartón</button>
                </div>
            );
        };

        const FactoryMode = ({ onBack }) => {
            const [grid, setGrid] = useState(generate90BallCard());
            const [c, setC] = useState(1);
            const cardRef = useRef(null);
            const next = async () => {
                const ca = await html2canvas(cardRef.current, {scale:2, backgroundColor:null});
                const l = document.createElement('a'); l.download=`Amigo_${c}.png`; l.href=ca.toDataURL(); l.click();
                setTimeout(()=>{ setGrid(generate90BallCard()); setC(p=>p+1); }, 200);
            };
            return (
                <div className="flex flex-col items-center min-h-screen p-4 bg-slate-900 border-t-8 border-green-500">
                    <button onClick={onBack} className="self-start mb-4 p-2 bg-slate-800 rounded-full"><Icon name="arrowLeft"/></button>
                    <div className="text-2xl font-bold mb-2 text-green-400">Cartón #{c}</div>
                    <div className="bg-white p-1 rounded-xl shadow-lg mb-4 max-w-full overflow-hidden scale-75"><BingoCardVisual grid={grid} serial={`F-${c}`} cardRef={cardRef}/></div>
                    <button onClick={next} className="w-full max-w-sm py-4 bg-green-600 rounded-xl font-bold flex items-center justify-center gap-2"><Icon name="download"/> Descargar y Siguiente</button>
                </div>
            );
        };

        const CallerMode = ({ onBack }) => {
            const [history, setHistory] = useState([]);
            const [current, setCurrent] = useState(null);
            const [auto, setAuto] = useState(false);
            const [check, setCheck] = useState(false);
            const [audioEnabled, setAudioEnabled] = useState(false);
            const timer = useRef(null);

            // SISTEMA DE AUDIO POTENTE PARA MÓVILES
            const playAudio = (text) => {
                if (!window.speechSynthesis) return;
                
                // 1. Truco del oscilador para despertar bluetooth
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) {
                        const ctx = new AudioContext();
                        const osc = ctx.createOscillator();
                        osc.connect(ctx.destination);
                        osc.start();
                        osc.stop(ctx.currentTime + 0.05); // Bip microscópico
                    }
                } catch(e) {}

                // 2. Voz
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'es-ES';
                u.rate = 1;
                u.volume = 1;
                window.speechSynthesis.speak(u);
            };

            const activate = () => {
                playAudio("Sistema de voz conectado correctamente");
                setAudioEnabled(true);
            };

            const draw = () => {
                if (history.length >= 90) return setAuto(false);
                let n;
                do { n = Math.floor(Math.random()*90)+1; } while (history.includes(n));
                setHistory(prev => [n, ...prev]);
                setCurrent(n);
                playAudio(`${n}`);
            };

            useEffect(() => {
                if (auto && !check) timer.current = setInterval(draw, 4000);
                else clearInterval(timer.current);
                return () => clearInterval(timer.current);
            }, [auto, check, history]);

            if (!audioEnabled) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 p-6 text-center">
                        <div className="animate-pulse mb-6 text-pink-500"><Icon name="volume" size={64}/></div>
                        <h2 className="text-3xl font-black mb-4">ACTIVAR SONIDO</h2>
                        <button onClick={activate} className="w-full py-6 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl font-bold text-xl shadow-xl active:scale-95">CONECTAR ALTAVOZ</button>
                        <button onClick={()=>setAudioEnabled(true)} className="mt-8 text-slate-500 underline">Entrar sin sonido</button>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-screen p-2 max-w-3xl mx-auto">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={()=>{setAuto(false); onBack()}} className="p-2 bg-slate-800 rounded-full"><Icon name="arrowLeft"/></button>
                        <div className="bg-slate-800 px-3 py-1 rounded-full text-xs font-mono text-blue-300">{history.length}/90</div>
                        <button onClick={()=>{if(confirm("Reiniciar?")){setHistory([]);setCurrent(null);setAuto(false)}}} className="p-2 text-red-400"><Icon name="refresh"/></button>
                    </div>

                    <div className={`flex-1 flex flex-col items-center ${check?'opacity-10 pointer-events-none':''}`}>
                        <div onClick={()=>current && playAudio(`${current}`)} className="relative w-56 h-56 flex items-center justify-center mb-6 bg-slate-800 rounded-full border-8 border-slate-700 shadow-2xl">
                             <span className="text-9xl font-black">{current || "GO"}</span>
                        </div>
                        <div className="grid grid-cols-2 gap-4 w-full px-4">
                            <button onClick={()=>setAuto(!auto)} className={`p-6 rounded-xl font-bold text-xl flex items-center justify-center gap-2 ${auto?'bg-amber-500 animate-pulse':'bg-slate-700'}`}>
                                {auto ? <><Icon name="pause"/> PAUSA</> : <><Icon name="play"/> AUTO</>}
                            </button>
                            <button onClick={draw} disabled={auto} className="p-6 bg-blue-600 rounded-xl font-bold text-xl shadow-lg">SACAR</button>
                        </div>
                        <button onClick={()=>{setAuto(false);setCheck(true);playAudio("Comprobar")}} className="mt-4 w-full p-4 bg-pink-600 rounded-xl font-bold flex items-center justify-center gap-2 uppercase tracking-widest"><Icon name="ticket"/> ¡COMPROBAR!</button>
                    </div>

                    {!check && (
                        <div className="mt-4 bg-slate-800/50 p-2 rounded-lg border border-slate-700 overflow-y-auto max-h-[20vh]">
                            <div className="grid grid-cols-[repeat(10,minmax(0,1fr))] gap-1">
                                {Array.from({length:90},(_,i)=>i+1).map(n=>(
                                    <div key={n} className={`aspect-square text-[10px] flex items-center justify-center rounded ${history.includes(n)?'bg-blue-500 text-white':'text-slate-600'}`}>{n}</div>
                                ))}
                            </div>
                        </div>
                    )}

                    {check && (
                        <div className="absolute inset-0 bg-slate-900 z-50 p-4 flex flex-col">
                            <div className="flex justify-between mb-4"><h3 className="text-xl font-bold text-pink-500">COMPROBADOR</h3><button onClick={()=>{setCheck(false);playAudio("Seguimos")}} className="bg-slate-800 px-4 py-2 rounded">Volver</button></div>
                            <div className="flex-1 overflow-y-auto"><div className="grid grid-cols-10 gap-2">{Array.from({length:90},(_,i)=>i+1).map(n=>(<button key={n} onClick={()=>{ if(history.includes(n)) navigator.vibrate?.(50); else playAudio("Ese no ha salido"); }} className={`aspect-square font-bold rounded ${history.includes(n)?'bg-green-600':'bg-slate-800 text-slate-600'}`}>{n}</button>))}</div></div>
                            <div className="grid grid-cols-2 gap-4 mt-4"><button onClick={()=>{setCheck(false);playAudio("Línea correcta")}} className="p-4 bg-blue-600 font-bold rounded-xl">¡LÍNEA!</button><button onClick={()=>{setCheck(false);playAudio("Bingo, tenemos ganador")}} className="p-4 bg-pink-600 font-bold rounded-xl">¡BINGO!</button></div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('menu');
            return mode === 'menu' ? <MainMenu onSelectMode={setMode} /> : 
                   mode === 'player' ? <PlayerMode onBack={()=>setMode('menu')} /> :
                   mode === 'factory' ? <FactoryMode onBack={()=>setMode('menu')} /> :
                   <CallerMode onBack={()=>setMode('menu')} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

